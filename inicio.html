<!DOCTYPE html>
<html>
<!--_________________________________________________Inicio "HEAD"-->

<head>
    <meta charset="UTF-8">
    <title>Tipo de Producción</title>
    <link rel="icon" type="image/x-icon" href="media/img/logotipo_127x72.png">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert@2.1.2/dist/sweetalert.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!--Inicio Librería calendario-->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.5.1/main.css' rel='stylesheet' />
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.5.1/main.js'></script>
    <!--Fin librería calendario-->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.16.6/dist/sweetalert2.min.js"></script>
</head>
<!--_____________________________________________________Fin "HEAD"-->

<!--__________________________________________________Inicio "BODY"-->

<body>
    <div class="contenedor-inicio">
        <!--_______________________________Inicio "Barra de navegación"-->
        <div class="navbar">
            <button onclick="window.location.href='inicio.html'" class="boton-inicio">Inicio</button>
            <button onclick="window.location.href='produccion_diaria.html'" class="boton-inicio">Refrigerado</button>
            <img src="media/img/logotipo_171x94.png" alt="Logotipo SSR">
            <button onclick="window.location.href='produccion_diaria_cong.html'" class="boton-inicio">Congelado</button>
            <button onclick="cerrarSesion()" class="boton-inicio">Cerrar</button>
        </div>
        <!--_________________________________Inicio "Usuario conectado"-->
        <div id="usuario-conectado" class="usuario-conectado">
            Usuario: <span id="email-usuario"></span>
        </div>
        <!--____________________________________Fin "Usuario conectado"-->
        <!--__________________________________Fin "Barra de navegación"-->
        <!--________________________________________Inicio "calendario"-->
        <div class="conjunto-calendario">
            <div class="modelo-selector">
                <label for="modelo">Selecciona un modelo:</label>
                <select id="modelo">
                    <option value="modelo-1">TP_H</option>
                    <option value="modelo-2">TNP_H</option>
                    <option value="modelo-3">DF</option>
                    <option value="modelo-4">DS</option>
                    <option value="modelo-5">VAC</option>
                    <option value="modelo-6">AR</option>
                    <option value="modelo-7">ANR</option>
                    <option value="modelo-8">DBT</option>
                    <option value="modelo-9">DBE</option>
                    <option value="modelo-10">FES</option>
                </select>
            </div>
            <button onclick="guardarCambiosEnCookies()" style="height: 50px; width: 300px; margin-top: 20px;">Guardar
                Cambios</button>
            <div id="calendario" class="calendario"></div>
        </div>
        <!--Inicio configuración JS-->
        <script>
            /*·····················································································*/
            // Configuraciòn del calendario "Configuración general"
            /*·····················································································*/
            document.addEventListener('DOMContentLoaded', function () {
                function aplicarCambiosDesdeCookie() {
                    // Recupera los datos de la cookie
                    var cookies = document.cookie.split(';');
                    var cambiosCookie = '';

                    cookies.forEach(function (cookie) {
                        if (cookie.trim().startsWith('cambiosCalendario=')) {
                            cambiosCookie = cookie.replace('cambiosCalendario=', '');
                        }
                    });

                    if (cambiosCookie) {
                        // Convierte la cadena JSON de la cookie de nuevo a un objeto
                        var cambios = JSON.parse(cambiosCookie);

                        // Aplica los cambios al calendario
                        for (var fecha in cambios) {
                            var clases = cambios[fecha];
                            var cell = document.querySelector('.fc-day[data-date="' + fecha + '"]');
                            if (cell) {
                                cell.className = 'fc-day ' + clases;
                            }
                        }
                    }
                }

                // Llama a la función para aplicar los cambios desde la cookie al cargar la página
                aplicarCambiosDesdeCookie();

                var calendarEl = document.getElementById('calendario');
                var modeloSelector = document.getElementById('modelo');

                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'es', // Configura el idioma en español
                    firstDay: 1, // Establece el primer día de la semana en lunes (1)
                    selectable: true, // Permite seleccionar fechas
                    select: function (info) {
                        // No hacemos nada cuando se selecciona una fecha
                    },
                    dateClick: function (info) {
                        // Obtiene el modelo seleccionado
                        var modeloSeleccionado = modeloSelector.value;

                        // Obtiene la casilla seleccionada
                        var cell = info.dayEl;

                        // Si la casilla ya tiene la clase del modelo seleccionado, quítala; de lo contrario, agrégala
                        if (cell.classList.contains(modeloSeleccionado)) {
                            cell.classList.remove(modeloSeleccionado);
                            // Elimina el cambio de la cookie
                            var fechaStr = info.date.toISOString();
                            var cambios = JSON.parse(document.cookie.replace(/(?:(?:^|.*;\s*)cambiosCalendario\s*=\s*([^;]*).*$)|^.*$/, "$1")) || {};
                            delete cambios[fechaStr];
                            document.cookie = 'cambiosCalendario=' + JSON.stringify(cambios) + '; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                        } else {
                            cell.classList.add(modeloSeleccionado);
                            // Guarda el cambio en la cookie
                            var fechaStr = info.date.toISOString();
                            var cambios = JSON.parse(document.cookie.replace(/(?:(?:^|.*;\s*)cambiosCalendario\s*=\s*([^;]*).*$)|^.*$/, "$1")) || {};
                            cambios[fechaStr] = modeloSeleccionado;
                            document.cookie = 'cambiosCalendario=' + JSON.stringify(cambios) + '; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/;';
                        }
                    },
                    datesSet: function (info) {
                        // Este evento se dispara cuando cambia la fecha o la vista del calendario

                        // Llama a la función para aplicar los cambios desde la cookie al cambiar de mes
                        aplicarCambiosDesdeCookie();
                    }
                });

                calendar.render();
            });

            /*·····················································································*/
            // Configuraciòn del calendario "Configuración para almacenar los cambios en las cookies"
            /*·····················································································*/
            function guardarCambiosEnCookies() {
                var calendarEl = document.getElementById('calendario');
                var cells = calendarEl.querySelectorAll('.fc-day');

                var cambios = {};

                cells.forEach(function (cell) {
                    var fecha = cell.getAttribute('data-date');
                    var clases = cell.classList.toString();
                    cambios[fecha] = clases;
                });


                // Convierte el objeto a una cadena JSON y guárdalo en una cookie
                document.cookie = 'cambiosCalendario=' + JSON.stringify(cambios) + '; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/';

            }


            /*·····················································································*/
            // Configuraciòn del calendario "Configuración para recuperar los datos de las cookies"
            /*·····················································································*/
            document.addEventListener('DOMContentLoaded', function () {
                // Recupera los datos de la cookie
                var cookies = document.cookie.split(';');
                var cambiosCookie = '';

                cookies.forEach(function (cookie) {
                    if (cookie.trim().startsWith('cambiosCalendario=')) {
                        cambiosCookie = cookie.replace('cambiosCalendario=', '');
                    }
                });

                if (cambiosCookie) {
                    // Convierte la cadena JSON de la cookie de nuevo a un objeto
                    var cambios = JSON.parse(cambiosCookie);

                    // Aplica los cambios al calendario
                    for (var fecha in cambios) {
                        var clases = cambios[fecha];
                        var cell = document.querySelector('.fc-day[data-date="' + fecha + '"]');
                        if (cell) {
                            cell.className = 'fc-day ' + clases;
                        }
                    }
                }

            });

        </script>
        <!--Fin configuración JS-->
        <!--___________________________________________Fin "calendario"-->

        <!--_______________________________________Inicio incidencias-->
        <div class="incidencias">
            <button id="openModal" class="botInc">Introducir incidencia</button>
            <h2>Incidencias</h2>
            <div id="historico" class="historico-incidencias">
                <!-- Aquí se cargarán las incidencias -->
            </div>
        </div>
        <script>
            document.getElementById("openModal").addEventListener("click", function () {
                swal({
                    title: "Introducir incidencia",
                    text: "Por favor, introduce los detalles de la incidencia:",
                    content: {
                        element: "input",
                        attributes: {
                            placeholder: "Descripción de la incidencia",
                            type: "text"
                        }
                    },
                    buttons: {
                        confirm: {
                            text: "Enviar",
                            value: true,
                            visible: true,
                            closeModal: true
                        },
                        cancel: {
                            text: "Cancelar",
                            value: null,
                            visible: true,
                            closeModal: true
                        }
                    }
                }).then(function (value) {
                    if (value) {
                        var descripcion = value; // Obtén la descripción de la incidencia

                        // Envia los datos al archivo PHP utilizando AJAX y jQuery
                        $.ajax({
                            type: "POST",
                            url: "insertar_incidencia.php",
                            data: {
                                descripcion: descripcion
                            },
                            success: function (response) {
                                console.log(response); // Muestra la respuesta del servidor en la consola
                                swal("Incidencia introducida", response);
                                location.reload();
                            },
                            error: function (xhr, status, error) {
                                console.error(error); // Muestra el error en la consola
                                swal("Error al introducir la incidencia");
                            }
                        });
                    }
                });
                cargarHistoricoIncidencias();
            });
            function cargarHistoricoIncidencias() {
                var historicoContainer = document.getElementById("historico");

                // Limpia el contenido previo
                historicoContainer.innerHTML = "";

                // Realiza una llamada AJAX para obtener las incidencias desde la base de datos
                $.ajax({
                    url: "obtener_incidencias.php",
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        data.forEach(function (incidencia) {
                            // Crea un botón para cada incidencia y agrega un evento click para mostrar la descripción
                            var botonIncidencia = document.createElement("button");
                            botonIncidencia.innerText = new Date(incidencia.fecha).toLocaleString(); // Formatea la fecha
                            botonIncidencia.classList.add("boton-incidencia");

                            botonIncidencia.addEventListener("click", function () {
                                // Muestra la descripción en una ventana modal
                                swal({
                                    title: "Incidencia del " + new Date(incidencia.fecha).toLocaleString(),
                                    text: incidencia.descripcion,
                                    icon: "info",
                                });
                            });

                            historicoContainer.appendChild(botonIncidencia);
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                    }
                });
            }

            // Carga el histórico cuando se carga la página
            cargarHistoricoIncidencias();
        </script>
        <!--__________________________________________Fin incidencias-->


        <!--____________________________________________Inicio "footer"-->
        <div class="footer">
            <footer>
                <a href="mailto:ssrspaingroup@gmail.com">Enviar un correo</a> -
                © <span id="year"></span> Todos los derechos reservados.
            </footer>
        </div>
        <!--_______________________________________________Fin "footer"-->
    </div>
    <!--_______________________Inicio LLamada al documeto logica.js-->
    <script src="logica.js"></script>
    <!--__________________________Fin LLamada al documeto logica.js-->
    <!--_________________________________Fin "Contenedor principal"-->
</body>

</html>