<!DOCTYPE html>
<html>
<!--_________________________________________________Inicio "HEAD"-->

<head>
    <meta charset="UTF-8">
    <title>Tipo de Producción</title>
    <link rel="icon" type="image/x-icon" href="media/img/logotipo_127x72.png">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert@2.1.2/dist/sweetalert.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<!--_____________________________________________________Fin "HEAD"-->

<!--__________________________________________________Inicio "BODY"-->

<body>
    <div class="contenedor-inicio">
        <!--_______________________________Inicio "Barra de navegación"-->
        <div class="navbar">
            <button onclick="window.location.href='inicio.html'" class="boton-inicio">Inicio</button>
            <button onclick="window.location.href='produccion_diaria.html'" class="boton-inicio">Refrigerado</button>
            <img src="media/img/logotipo_171x94.png" alt="Logotipo SSR">
            <button onclick="window.location.href='produccion_diaria_cong.html'" class="boton-inicio">Congelado</button>
            <button onclick="cerrarSesion()" class="boton-inicio">Cerrar</button>
        </div>
        <!--_________________________________Inicio "Usuario conectado"-->
        <div id="usuario-conectado" class="usuario-conectado">
            Usuario: <span id="email-usuario"></span>
        </div>
        <!--____________________________________Fin "Usuario conectado"-->
        <!--__________________________________Fin "Barra de navegación"-->
        <div class="datos-contenedor">
            <!--_______________________________________Inicio "Refrigerado"-->
            <div class="canvasRefr">
                <h2>Refrigerado</h2>
                <canvas id="grafico-produccion" width="600" height="300"></canvas>
            </div>
            <!--_______________________________________________________________REFRIGERADO-->
            <!--____________________________Inicio script para crear canvas-->
            <script>
                function generateChartRefrigerado(data) {
                    var fechas = data.map(function (item) {
                        return item.fecha;
                    });

                    var metrosCubicos = data.map(function (item) {
                        return item.metros_cubicos;
                    });

                    var ctx = document.getElementById("grafico-produccion").getContext("2d");
                    var myChartRefrigerado = new Chart(ctx, {
                        type: "bar",
                        data: {
                            labels: fechas,
                            datasets: [{
                                label: "Producción Diaria (Metros Cúbicos)",
                                data: metrosCubicos,
                                backgroundColor: "rgba(55, 69, 138, 0.9)",
                                borderColor: "rgba(255, 0, 0, 1)",
                                borderWidth: 2
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                var xhrRefrigerado = new XMLHttpRequest();
                xhrRefrigerado.open("GET", "mostrar_produccion.php", true);
                xhrRefrigerado.onreadystatechange = function () {
                    if (xhrRefrigerado.readyState === 4 && xhrRefrigerado.status === 200) {
                        var produccionData = JSON.parse(xhrRefrigerado.responseText);
                        generateChartRefrigerado(produccionData);
                    }
                };
                xhrRefrigerado.send();
            </script>
            <!--_______________________________Fin script para crear canvas-->
            <!--__________________________________________Fin "Refrigerado"-->

            <!--_______________________________________Inicio "Congelado"-->
            <div class="canvasCong">
                <h2>Congelado</h2>
                <canvas id="graficoProduccionCongelado" width="600" height="300"></canvas>
            </div>
            <!--_______________________________________________________________CONGELADO-->
            <!--____________________________Inicio script para crear canvas-->
            <script>
                function generateChartCongelado(data) {
                    var fechas = data.map(function (item) {
                        return item.fecha;
                    });

                    var metrosCubicos = data.map(function (item) {
                        return item.metros_cubicos;
                    });

                    var ctx = document.getElementById("graficoProduccionCongelado").getContext("2d");
                    var myChartCongelado = new Chart(ctx, {
                        type: "bar",
                        data: {
                            labels: fechas,
                            datasets: [{
                                label: "Producción Diaria (Metros Cúbicos)",
                                data: metrosCubicos,
                                backgroundColor: "rgba(255, 255, 255, 0.9)",
                                borderColor: "rgba(255, 0, 0, 1)",
                                borderWidth: 2
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                var xhrCongelado = new XMLHttpRequest();
                xhrCongelado.open("GET", "mostrar_produccion_cong.php", true);
                xhrCongelado.onreadystatechange = function () {
                    if (xhrCongelado.readyState === 4 && xhrCongelado.status === 200) {
                        var produccionData = JSON.parse(xhrCongelado.responseText);
                        generateChartCongelado(produccionData);
                    }
                };
                xhrCongelado.send();
            </script>
            <!--_______________________________Fin script para crear canvas-->
            <!--__________________________________________Fin "Congelado"-->
        </div>
        <!--_______________________________________Inicio incidencias-->
        <div class="incidencias">
            <button id="openModal" class="botInc">Introducir incidencia</button>
            <h2>Incidencias</h2>
            <div id="historico" class="historico-incidencias">
                <!-- Aquí se cargarán las incidencias -->
            </div>
        </div>
        <!--Obtener incidencias-->
        <script>


        </script>

        <script>
            document.getElementById("openModal").addEventListener("click", function () {
                swal({
                    title: "Introducir incidencia",
                    text: "Por favor, introduce los detalles de la incidencia:",
                    content: {
                        element: "input",
                        attributes: {
                            placeholder: "Descripción de la incidencia",
                            type: "text"
                        }
                    },
                    buttons: {
                        confirm: {
                            text: "Enviar",
                            value: true,
                            visible: true,
                            closeModal: true
                        },
                        cancel: {
                            text: "Cancelar",
                            value: null,
                            visible: true,
                            closeModal: true
                        }
                    }
                }).then(function (value) {
                    if (value) {
                        var descripcion = value; // Obtén la descripción de la incidencia

                        // Envia los datos al archivo PHP utilizando AJAX y jQuery
                        $.ajax({
                            type: "POST",
                            url: "insertar_incidencia.php",
                            data: {
                                descripcion: descripcion
                            },
                            success: function (response) {
                                console.log(response); // Muestra la respuesta del servidor en la consola
                                swal("Incidencia introducida", response);
                                location.reload();
                            },
                            error: function (xhr, status, error) {
                                console.error(error); // Muestra el error en la consola
                                swal("Error al introducir la incidencia");
                            }
                        });
                    }
                });
                cargarHistoricoIncidencias();
            });
            function cargarHistoricoIncidencias() {
                var historicoContainer = document.getElementById("historico");

                // Limpia el contenido previo
                historicoContainer.innerHTML = "";

                // Realiza una llamada AJAX para obtener las incidencias desde la base de datos
                $.ajax({
                    url: "obtener_incidencias.php",
                    type: "GET",
                    dataType: "json",
                    success: function (data) {
                        data.forEach(function (incidencia) {
                            // Crea un botón para cada incidencia y agrega un evento click para mostrar la descripción
                            var botonIncidencia = document.createElement("button");
                            botonIncidencia.innerText = new Date(incidencia.fecha).toLocaleString(); // Formatea la fecha
                            botonIncidencia.classList.add("boton-incidencia");

                            botonIncidencia.addEventListener("click", function () {
                                // Muestra la descripción en una ventana modal
                                swal({
                                    title: "Incidencia del " + new Date(incidencia.fecha).toLocaleString(),
                                    text: incidencia.descripcion,
                                    icon: "info",
                                });
                            });

                            historicoContainer.appendChild(botonIncidencia);
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                    }
                });
            }

            // Carga el histórico cuando se carga la página
            cargarHistoricoIncidencias();
        </script>
        <!--__________________________________________Fin incidencias-->


        <!--____________________________________________Inicio "footer"-->
        <div class="footer">
            <footer>
                <a href="mailto:ssrspaingroup@gmail.com">Enviar un correo</a> -
                © <span id="year"></span> Todos los derechos reservados.
            </footer>
        </div>
        <!--_______________________________________________Fin "footer"-->
    </div>
    <!--_______________________Inicio LLamada al documeto logica.js-->
    <script src="logica.js"></script>
    <!--__________________________Fin LLamada al documeto logica.js-->
    <!--_________________________________Fin "Contenedor principal"-->
</body>

</html>